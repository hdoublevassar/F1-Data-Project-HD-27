---
title: "F1-API-Setup"
output: 
  html_document:
    code_folding: show
    theme:
      bg: "#202123"
      fg: "#B8BCC2"
      primary: "#EA80FC"
      base_font:
        google: Prompt
      heading_font:
        google: Proza Libre
      version: 3
---


```{r Libraries}
library(tidyverse)
library(ggplot2)
library(jsonlite)
library(httr)
```

#Using the OpenF1 API, this chunk aims to retreive data on F1 sessions, which will be filtered and used to iscolate perfomrance data.
```{r Sessions-API}
# Get all drivers for the session
#url <- "https://api.openf1.org/v1/drivers?session_key=9158" # nolint: commented_code_linter.

# For sessions:
url_sessions <- "https://api.openf1.org/v1/sessions"
##Data that will be built off of sessions_data, I just need to have acess to the session key here for ease of use and constructing the divers tables
# For positions: url_positions <- "https://api.openf1.org/v1/position?session_key=9158"
# For lap times: url_laps <- "https://api.openf1.org/v1/laps?session_key=9158"
# For car data: url_car_data <- "https://api.openf1.org/v1/car_data?session_key=9158"

resp <- httr::GET(url_sessions)
if (resp$status_code != 200) {
  stop("Request failed: ", resp$status_code, " — ", httr::content(resp, "text"))
}

text <- httr::content(resp, "text", encoding = "UTF-8")
session_data <- jsonlite::fromJSON(text, simplifyVector = TRUE)
print(session_data)
```

#Filtering down to just Race Sessions in the Year  2025
```{r Filter-Sessions}
##I am creating a new dataframe that 2025-filters the session_data dataframe, isolating just the session type and the year

race_sessions_2025 <- dplyr::filter(session_data, session_name == "Race", year == 2025) 
```
# Adding this chunk to filter down to just race sessions of all time
```{r Race_Sessions Total}
race_sessions <- dplyr::filter(session_data, session_name == "Race")
```
# This chunk is completely unnecessary currently, but it is could be potentially useful later on so I figured I'd throw it in now lol
```{r Meetings-API}
url_meetings <- "https://api.openf1.org/v1/meetings"
##Honestly not important, but figured I might as well add it in here in case I need it later
resp <- httr::GET(url_meetings)
if (resp$status_code != 200) {
  stop("Request failed: ", resp$status_code, " — ", httr::content(resp, "text"))
}

text <- httr::content(resp, "text", encoding = "UTF-8")
meeting_data <- jsonlite::fromJSON(text, simplifyVector = TRUE)
print(meeting_data)
```

# This chunk is intended to retreave all pitstop data from the OpenF1 API, which will be used to analyze pitstops
# For pitstops:
```{r Pitstops-API}
#Creating a new dataframe for pitstop data
url_pitstops <- "https://api.openf1.org/v1/pit"

resp <- httr::GET(url_pitstops)
if (resp$status_code != 200) {
  stop("Request failed: ", resp$status_code, " — ", httr::content(resp, "text"))
}

text <- httr::content(resp, "text", encoding = "UTF-8")
pitstop_data <- jsonlite::fromJSON(text, simplifyVector = TRUE)
```


# Finding the Unique IDs for all Race Sessions I have data for
```{r Unique-Session-IDs}
unique_race_session_ids <- unique(race_sessions$session_key)
print(unique_race_session_ids)
```
# Then I am filtering the pitstop data to only include pitstops from those sessions
```{r Pitstop-Race-Only}
pitstop_race_only <- dplyr::filter(pitstop_data, session_key %in% unique_race_session_ids)

#Now I am going to rilter the data down to pitstops under 60 seconds, and I will call anything longer than that a DNF

```
# I am going to create a graph of all pitstops that I have data for, breaking it down by driver and calculating the average pitstop length
```{r pitstop analysis}
pitstop_averages <- pitstop_data %>%
  group_by(driver_number) %>%
  summarise(average_pitstop_time = mean(pit_duration, na.rm = TRUE)) %>%
  arrange(average_pitstop_time)

```